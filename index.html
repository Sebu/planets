<!DOCTYPE html>
<html lang="en">
<head> 
	<title>webgl ancient planet visualization</title> 
	<meta charset="utf-8" />
	<link rel="stylesheet" type="text/css" href="css/planets.css">
</head>

<body>
<div class="container" id="uiContainer">
	 View
   <select name="view" onchange="setCurrentPos(this.options[this.selectedIndex].value);">
      <option value="global">Global</option>
      <option value="earth">Earth</option>
      <option value="mercury">Mercury</option>
    </select>
   <div>Speed<input type="range" id="speedRange" min="5" max="60" value="15"/></div>
   </br>
   Change
	<select onchange='setCurrentPlanet(this.options[this.selectedIndex].value);'> <option value='mercury'>Mercury</option></select>   
   <div id="parameters">
   <div><input type="range" id="angleSys1" min="0" max="360" value="24"/></div>
   <div><input type="range" id="speedSys1" min="0" max="5" value="0"/></div>
   <div><input type="range" id="angleSys2" min="0" max="360" value="90"/></div>  
   <div><input type="range" id="speedSys2" min="0" max="5" value="1"/></div>
   <div><input type="range" id="angleSys3" min="0" max="360" value="90"/></div>  
   <div><input type="range" id="speedSys3" min="0" max="5" value="3"/></div>   
   </div>
</div>

<div class="container" id="infoContainer">
 Nice Planet Model
</div>

<div class="container" id="helpContainer">
Hilfe </br>
W,A,S,D + Mouse
</div>

<canvas id="glCanvas" tabindex=1>
  <p>This example requires a browser that supports the
     <a href="http://www.w3.org/html/wg/html5/">HTML5</a> 
     &lt;canvas&gt; and <a href="http://www.khronos.org/webgl/WebGL">WebGL</a> features.</p> 
</canvas>


<script type="text/javascript" src="libs/jquery.tools.min.js"></script> 
<script type="text/javascript" src="libs/scenejs.js"></script> 
<script type="text/javascript" src="libs/scenejs-query-node-pos.js"></script> 
<script type="text/javascript" src="libs/planetsviz.js"></script>
  
<script type="text/javascript"> 


var canvas = document.getElementById("glCanvas");


var currentPos = "global";
var scale = 360.0/(30*15);
var yaw = 0;
var pitch = 0;
var lastX;
var lastY;
var dragging = false;

function setCurrentPos(pos) { currentPos=pos;  		changeView(currentPos); }

function setCurrentPlanet(node) {
	$("#angleSys1").bind("onSlide", function(event, value) { system[1].setAxis(value); } );
	$("#angleSys1").bind("change", function(event, value) { system[1].setAxis(value); } );
	$("#angleSys2").bind("onSlide", function(event, value) { system[2].setAxis(value); } );
	$("#angleSys2").bind("change", function(event, value) { system[2].setAxis(value); } );
	$("#angleSys3").bind("onSlide", function(event, value) { system[3].setAxis(value); } );
	$("#angleSys3").bind("change", function(event, value) { system[3].setAxis(value); } );
	
	$("#speedSys1").bind("onSlide", function(event, value) { system[1].setSpeed(value); } );
	$("#speedSys1").bind("change", function(event, value) { system[1].setSpeed(value); } );
	$("#speedSys2").bind("onSlide", function(event, value) { system[2].setSpeed(value); } );
	$("#speedSys2").bind("change", function(event, value) { system[2].setSpeed(value); } );
	$("#speedSys3").bind("onSlide", function(event, value) { system[3].setSpeed(value); system[4].setSpeed(-value);  } );
	$("#speedSys3").bind("change", function(event, value) { system[3].setSpeed(value); system[4].setSpeed(-value); } );
	
}




$(":range").rangeinput({ progress: true });

setCurrentPlanet("mercury");
$("#speedRange").bind("onSlide", function(event, value) { scale=360.0/(30*value); } );
$("#speedRange").bind("change", function(event, value) { scale=360.0/(30*value); } );

function mouseDown(event) {
    lastX = event.clientX;
    lastY = event.clientY;
    dragging = true;

//    SceneJS.withNode("theScene").pick(event.offsetX, event.offsetY);
}

function mouseUp() {
    dragging = false;

}

// base structure
var scene = SceneJS.scene({ canvasId: "glCanvas" },
  renderer = SceneJS.renderer({  id: "renderer" ,           
    clear: { depth : true, color : true },
    clearColor: { r: 0.2, g : 0.2, b : 0.2 },
    enableCullFace: true, cullFace: "back", frontFace: "cw"
    },
  	lookAt = SceneJS.lookAt({ eye : { x: 0.0, y: 0.0, z: -25 }, look : { x:0.0, y:0.0, z:1.0 }, up: { x:0.0, y: 1.0, z: 0.0 } },
      camera = SceneJS.camera({},
			  light = sunlight(),
			  SceneJS.rotate({id: "pitch", angle: 0.0, x: 1.0},
			    anchor = SceneJS.rotate({id: "yaw", angle: 0.0, y: 1.0}
	  	    )
        )
		  )
	  )
  )
);

/* On a mouse drag, we'll re-render the scene, passing in
 * incremented angles in each time.
 */
function mouseMove(event) {
    if (dragging) {
        yaw += (event.clientX - lastX) * 0.5;
        pitch += (event.clientY - lastY) * -0.5;
        
//        lookAt.rotate(pitch*0.005,yaw*0.005,0.0);
//        lookAt.update();
        SceneJS.withNode("yaw").set("angle", yaw);
        SceneJS.withNode("pitch").set("angle", pitch);

        scene.render();

        lastX = event.clientX;
        lastY = event.clientY;
    }
}

function keyboard(e) {
	switch(e.keyCode) {
		case 119: lookAt.translate(0,0,1.2);  break;
		case 115: lookAt.translate(0,0,-1.2);  break;
		case 97: lookAt.translate(-1.2,0,0);  break;
		case 100: lookAt.translate(1.2,0,0);  break;		
		default: return false;
	}
}

function mouseWheel(event) {
	lookAt.translate(0.0,0.0,event.wheelDelta/120);
}
function mouseWheel_firefox(event) {
	lookAt.translate(0.0,0.0,event.detail);
}

canvas.addEventListener('mousedown', mouseDown, true);
canvas.addEventListener('mousemove', mouseMove, true);
canvas.addEventListener('mouseup', mouseUp, true);
canvas.addEventListener('keypress', keyboard, true);
canvas.addEventListener('mousewheel', mouseWheel, true);
canvas.addEventListener('DOMMouseScroll', mouseWheel_firefox, true);




//			      //new SceneJS.Stationary()
//anchor.addNode(new SceneJS.Globe({scale: -20.0, emit: 0.5, tex: "textures/starsmap.jpg"}));
anchor.addNode(new SceneJS.Globe({scale: 0.4, id: "earth", tex: "textures/earthmap1k.jpg"}));

// mercury system
var system = [];

							
anchor.addNode(	system[0] = SceneJS.spherical({scale: 9, angle: 0.0, speed: 0.0, color: {r:1.0, g: 1.0, b: 1.0}},
				      		system[1] =	SceneJS.spherical({ scale: 9, angle: 24.0, speed: 0.0, color: {r:0.2, g:0.2, b:1.0} },
						    		system[2] = SceneJS.spherical({ scale: 9, angle: 90.0, speed: 1.0, color: {r: 0.0, g: 1.0, b: 0.0} },
  						  		  system[3] = SceneJS.spherical({ scale: 9, angle: 30.0, speed: 3.0, color: {r: 1.0, g: 0.0, b: 0.0}},
                		    system[4] = new SceneJS.Planet({ speed: -3.0, emit: 0.0, scale: 0.3, inner_id: "mercury", tex: "textures/mercurymap.jpg"})
                		  )
					 		  		)
						  		)	
							  )
							);

system[0].setVisuals(false);




//system[1]._anchor.addNode( sun = SceneJS.spherical({ scale: 9, angle: 10.0, speed: 1.0, color: {r:0.0, g:1.0, b:0.0} },
//                 new SceneJS.Planet({ speed: -1.0, emit: 1.0, scale: 0.3, inner_id: "sun", tex: "textures/sunmap.jpg"})
//	              )
//					);
							
// TODO: calc max points and max motion estimation
calcCurve = function(start,node) {
	curvePos = [];
	oldAxis = [];
	for(var i=0; i<=start; i++) {
		oldAxis[i] = system[i].getAxis();
		system[i].setAxis(0.0);
		system[i].setRotate(0.0);
	}
	for(var j=0; j<800; j+=5) {
		for(var i=start+1; i<system.length; i++) {
			tmp = j*system[i]._ySpeed;
			system[i].setRotate(-tmp);
		}
		pos = getNodePos(node);
		curvePos.push(pos);
	}
	for(var i=0; i<=start;i++)
		system[i].setAxis(oldAxis[i]);

  for(var i=start+1; i<system.length; i++)
					system[i].setRotate(0.0);

	curve = new SceneJS.Curve({pos: curvePos});	
	system[start]._zRotate.addNode(curve);	
}

resize = function() {
	canvas.width = $(window).width();	
	canvas.height = $(window).height();
	camera.setOptics({ type: "perspective", fovy : 45.0, aspect : canvas.width/canvas.height, near : 0.10, far : 500.0});
	renderer._props.props.viewport =  { x : 1, y : 1, width: canvas.width, height: canvas.height };
}



function changeView(node) {
	if(node=="global") pos = { x: 0.0, y: 0.0, z: -25 };
	else pos = getNodePos(node);
	lookAt.setEye(pos);
} 

window.render = function() {
	for(i in system) {
			system[i].update(scale);
  }
//		sun.update(scale);

		//TODO: on model change -> events?
		light.setPos(getNodePos("mercury"));
    scene.render(); 
};

SceneJS.withNode("mercury").bind("picked",
        function(event) {
            alert("Picked: 'right-green-sphere'");
        });



setInterval("window.render()", 33);  
window.onresize=resize;
calcCurve(1,"mercury");
resize();


</script>
</body>
</html>
